<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test NexusVite App Store</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        button.danger {
            background: #ef4444;
        }
        button.danger:hover {
            background: #dc2626;
        }
        button.success {
            background: #10b981;
        }
        button.success:hover {
            background: #059669;
        }
        .app-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        .app-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }
        .app-version {
            font-size: 12px;
            color: #6b7280;
            background: #e5e7eb;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .app-description {
            color: #6b7280;
            margin: 10px 0;
            font-size: 14px;
        }
        .app-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }
        .tag {
            font-size: 11px;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .status.active {
            background: #dcfce7;
            color: #166534;
        }
        .status.installed {
            background: #fef3c7;
            color: #92400e;
        }
        pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
        h2 {
            color: #111827;
            margin-bottom: 15px;
        }
        .links {
            margin-top: 20px;
            padding: 15px;
            background: #eff6ff;
            border-radius: 8px;
        }
        .links a {
            color: #2563eb;
            text-decoration: none;
            margin-right: 15px;
        }
        .links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>🚀 NexusVite App Store Test</h1>

    <div class="links">
        <strong>Quick Links:</strong>
        <a href="http://localhost:3000/dashboard/apps" target="_blank">Platform App Store</a>
        <a href="http://localhost:3001" target="_blank">Analytics App</a>
        <a href="http://localhost:3000/login" target="_blank">Platform Login</a>
    </div>

    <div class="container">
        <h2>📦 Available Apps</h2>
        <div id="available-apps">Loading...</div>
        <button onclick="fetchAvailableApps()">Refresh Available Apps</button>
    </div>

    <div class="container">
        <h2>✅ Installed Apps</h2>
        <div id="installed-apps">Loading...</div>
        <button onclick="fetchInstalledApps()">Refresh Installed Apps</button>
    </div>

    <div class="container">
        <h2>🧪 Test Actions</h2>
        <button onclick="installAnalytics()">Install Analytics Dashboard</button>
        <button onclick="testSearch()">Search for "analytics"</button>
        <button onclick="testCategory()">Get Analytics Category</button>
        <button class="success" onclick="openPlatformAppStore()">Open Platform App Store</button>
    </div>

    <div class="container">
        <h2>📊 API Response</h2>
        <pre id="response">Ready for testing...</pre>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        // Fetch available apps
        async function fetchAvailableApps() {
            try {
                const response = await fetch(`${API_BASE}/apps`);
                const data = await response.json();

                displayResponse('Available Apps', data);

                const container = document.getElementById('available-apps');
                if (data.apps && data.apps.length > 0) {
                    container.innerHTML = data.apps.map(app => createAppCard(app, false)).join('');
                } else {
                    container.innerHTML = '<p>No apps available</p>';
                }
            } catch (error) {
                displayError('Failed to fetch available apps', error);
            }
        }

        // Fetch installed apps
        async function fetchInstalledApps() {
            try {
                const response = await fetch(`${API_BASE}/apps?installed=true`);
                const data = await response.json();

                displayResponse('Installed Apps', data);

                const container = document.getElementById('installed-apps');
                if (data.apps && data.apps.length > 0) {
                    container.innerHTML = data.apps.map(app => createInstalledAppCard(app)).join('');
                } else {
                    container.innerHTML = '<p>No apps installed yet</p>';
                }
            } catch (error) {
                displayError('Failed to fetch installed apps', error);
            }
        }

        // Create app card HTML
        function createAppCard(app, installed = false) {
            return `
                <div class="app-card">
                    <div class="app-header">
                        <div>
                            <span class="app-title">${app.name}</span>
                            <span class="app-version">v${app.version}</span>
                        </div>
                        ${installed ? '<span class="status installed">Installed</span>' : ''}
                    </div>
                    <p class="app-description">${app.description}</p>
                    <div class="app-tags">
                        ${app.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <div>
                        ${app.pricing?.plans?.[0] ?
                            `<strong>Price:</strong> ${app.pricing.plans[0].price === 0 ? 'Free' : '$' + app.pricing.plans[0].price + '/mo'}`
                            : ''}
                    </div>
                    <div style="margin-top: 10px;">
                        ${!installed ?
                            `<button onclick="installApp('${app.id}')">Install</button>` :
                            `<button onclick="window.open('${app.homepage}', '_blank')">Open App</button>`
                        }
                        <button onclick="viewAppDetails('${app.id}')">View Details</button>
                    </div>
                </div>
            `;
        }

        // Create installed app card HTML
        function createInstalledAppCard(installation) {
            const app = installation.manifest;
            return `
                <div class="app-card">
                    <div class="app-header">
                        <div>
                            <span class="app-title">${app.name}</span>
                            <span class="app-version">v${app.version}</span>
                        </div>
                        <span class="status active">${installation.status}</span>
                    </div>
                    <p class="app-description">${app.description}</p>
                    <div style="margin-top: 10px;">
                        <button onclick="window.open('${app.homepage}', '_blank')">Open App</button>
                        <button class="danger" onclick="uninstallApp('${installation.id}')">Uninstall</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                        Installed: ${new Date(installation.installDate).toLocaleDateString()}
                    </div>
                </div>
            `;
        }

        // Install an app
        async function installApp(appId) {
            try {
                const response = await fetch(`${API_BASE}/apps`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appId })
                });

                const data = await response.json();

                if (response.ok) {
                    displayResponse(`App "${appId}" installed successfully!`, data);
                    fetchAvailableApps();
                    fetchInstalledApps();
                } else {
                    displayError(`Failed to install app "${appId}"`, data);
                }
            } catch (error) {
                displayError('Installation error', error);
            }
        }

        // Uninstall an app
        async function uninstallApp(installationId) {
            if (!confirm('Are you sure you want to uninstall this app?')) return;

            try {
                const response = await fetch(`${API_BASE}/apps/${installationId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    displayResponse('App uninstalled successfully!', data);
                    fetchAvailableApps();
                    fetchInstalledApps();
                } else {
                    displayError('Failed to uninstall app', data);
                }
            } catch (error) {
                displayError('Uninstall error', error);
            }
        }

        // View app details
        async function viewAppDetails(appId) {
            try {
                const response = await fetch(`${API_BASE}/apps/${appId}`);
                const data = await response.json();
                displayResponse(`App Details: ${appId}`, data);
            } catch (error) {
                displayError('Failed to fetch app details', error);
            }
        }

        // Test functions
        function installAnalytics() {
            installApp('com.nexusvite.analytics');
        }

        async function testSearch() {
            try {
                const response = await fetch(`${API_BASE}/apps?search=analytics`);
                const data = await response.json();
                displayResponse('Search Results for "analytics"', data);
            } catch (error) {
                displayError('Search error', error);
            }
        }

        async function testCategory() {
            try {
                const response = await fetch(`${API_BASE}/apps?category=analytics`);
                const data = await response.json();
                displayResponse('Analytics Category Apps', data);
            } catch (error) {
                displayError('Category error', error);
            }
        }

        function openPlatformAppStore() {
            window.open('http://localhost:3000/dashboard/apps', '_blank');
        }

        // Display functions
        function displayResponse(title, data) {
            document.getElementById('response').textContent =
                `✅ ${title}\n\n${JSON.stringify(data, null, 2)}`;
        }

        function displayError(title, error) {
            document.getElementById('response').textContent =
                `❌ ${title}\n\n${error.message || JSON.stringify(error, null, 2)}`;
        }

        // Initialize
        fetchAvailableApps();
        fetchInstalledApps();
    </script>
</body>
</html>